# Задание на оптимизацию запросов, разбор нескольких запросов с помощью explain

EXPLAIN SELECT id FROM users WHERE username='ora994';
+----+-------------+-------+------------+-------+-------------------------------+----------+---------+-------+------+----------+-------------+
| id | select_type | table | partitions | type  | possible_keys                 | key      | key_len | ref   | rows | filtered | Extra       |
+----+-------------+-------+------------+-------+-------------------------------+----------+---------+-------+------+----------+-------------+
|  1 | SIMPLE      | users | NULL       | const | username,users_username_index | username | 602     | const |    1 |   100.00 | Using index |
+----+-------------+-------+------------+-------+-------------------------------+----------+---------+-------+------+----------+-------------+

EXPLAIN SELECT * FROM sess WHERE user_id=5982;
+----+-------------+-------+------------+------+--------------------+--------------------+---------+-------+------+----------+-------+
| id | select_type | table | partitions | type | possible_keys      | key                | key_len | ref   | rows | filtered | Extra |
+----+-------------+-------+------------+------+--------------------+--------------------+---------+-------+------+----------+-------+
|  1 | SIMPLE      | sess  | NULL       | ref  | sess_user_id_index | sess_user_id_index | 4       | const |    1 |   100.00 | NULL  |
+----+-------------+-------+------------+------+--------------------+--------------------+---------+-------+------+----------+-------+
Здесь оптимизировано с помощью индекса sess_user_id_index.

EXPLAIN SELECT id FROM users WHERE id = 5982;
+----+-------------+-------+------------+-------+---------------------------+---------+---------+-------+------+----------+-------------+
| id | select_type | table | partitions | type  | possible_keys             | key     | key_len | ref   | rows | filtered | Extra       |
+----+-------------+-------+------------+-------+---------------------------+---------+---------+-------+------+----------+-------------+
|  1 | SIMPLE      | users | NULL       | const | PRIMARY,id,users_id_index | PRIMARY | 8       | const |    1 |   100.00 | Using index |
+----+-------------+-------+------------+-------+---------------------------+---------+---------+-------+------+----------+-------------+
Здесь можно заметить, что индекс users_id_index не нужен, так как уже есть встроенный индекс по id. (я его и подобные убрала)

Эти запросы оптимизированы с помощью индексов blogs_thread_id_index, blog_posts_id_index:

EXPLAIN SELECT id, title FROM blogs WHERE blogs.author_id = 5079;
 +----+-------------+-------+------------+------+-----------------------+-----------------------+---------+-------+------+----------+-------+
| id | select_type | table | partitions | type | possible_keys         | key                   | key_len | ref   | rows | filtered | Extra |
+----+-------------+-------+------------+------+-----------------------+-----------------------+---------+-------+------+----------+-------+
|  1 | SIMPLE      | blogs | NULL       | ref  | blogs_thread_id_index | blogs_thread_id_index | 4       | const |    1 |   100.00 | NULL  |
+----+-------------+-------+------------+------+-----------------------+-----------------------+---------+-------+------+----------+-------+

EXPLAIN SELECT * from blog_posts WHERE post_id = 30535;
+----+-------------+------------+------------+------+---------------------+---------------------+---------+-------+------+----------+-------+
| id | select_type | table      | partitions | type | possible_keys       | key                 | key_len | ref   | rows | filtered | Extra |
+----+-------------+------------+------------+------+---------------------+---------------------+---------+-------+------+----------+-------+
|  1 | SIMPLE      | blog_posts | NULL       | ref  | blog_posts_id_index | blog_posts_id_index | 4       | const |    1 |   100.00 | NULL  |
+----+-------------+------------+------------+------+---------------------+---------------------+---------+-------+------+----------+-------+

Среди запросов наиболее сложным является запрос на получение всех комментариев для 1 или нескольких пользователей в указанном блоге.


sql
SELECT c.text, c.created, c.author_id, c.post_id, c.comment_id FROM comments AS c JOIN posts  AS p ON c.post_id = p.id JOIN blog_posts AS b_p ON p.id = b_p.post_id WHERE blog_id = 495 AND (c.author_id = 5680 OR c.author_id=4996) ORDER BY c.id;

Выполняя его с EXPLAIN, получаем:

+----+-------------+-------+------------+--------+---------------------------+---------------------+---------+--------------------+-------+----------+------------------------------------+
| id | select_type | table | partitions | type   | possible_keys             | key                 | key_len | ref                | rows  | filtered | Extra                              |
+----+-------------+-------+------------+--------+---------------------------+---------------------+---------+--------------------+-------+----------+------------------------------------+
|  1 | SIMPLE      | c     | NULL       | index  | NULL                      | PRIMARY             | 8       | NULL               | 10031 |    19.00 | Using where                        |
|  1 | SIMPLE      | p     | NULL       | eq_ref | PRIMARY,id,posts_id_index | PRIMARY             | 8       | sys_base.c.post_id |     1 |   100.00 | Using where; Using index           |
|  1 | SIMPLE      | b_p   | NULL       | ref    | blog_posts_id_index       | blog_posts_id_index | 4       | sys_base.p.id      |     1 |    10.00 | Using index condition; Using where |
+----+-------------+-------+------------+--------+---------------------------+---------------------+---------+--------------------+-------+----------+------------------------------------+

Очевидно, что первая часть запроса выглядит крайне неоптимизированно: в качестве индекса используется PRIMARY, тип index, значит сканируется все дерево индексов, еще и строчек на выходе 10031.

Добавим индексы по post_id, author_id:
+----+-------------+-------+------------+--------+-----------------------------------------------+------------------------+---------+--------------------+------+----------+---------------------------------------+
| id | select_type | table | partitions | type   | possible_keys                                 | key                    | key_len | ref                | rows | filtered | Extra                                 |
+----+-------------+-------+------------+--------+-----------------------------------------------+------------------------+---------+--------------------+------+----------+---------------------------------------+
|  1 | SIMPLE      | c     | NULL       | range  | comments_post_id_index,comments_auth_id_index | comments_auth_id_index | 4       | NULL               |   21 |   100.00 | Using index condition; Using filesort |
|  1 | SIMPLE      | p     | NULL       | eq_ref | PRIMARY,id,posts_id_index                     | PRIMARY                | 8       | sys_base.c.post_id |    1 |   100.00 | Using where; Using index              |
|  1 | SIMPLE      | b_p   | NULL       | ref    | blog_posts_id_index                           | blog_posts_id_index    | 4       | sys_base.p.id      |    1 |    10.00 | Using index condition; Using where    |
+----+-------------+-------+------------+--------+-----------------------------------------------+------------------------+---------+--------------------+------+----------+---------------------------------------+

Теперь уже получше. Используется созданный нами индекс, строчек уже 21, а не 10031.



